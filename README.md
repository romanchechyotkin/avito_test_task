# ESTATE MANAGEMENT SERVICE

[![Build Status][ci-badge]][ci-runs]
![coverage][coverage-badge]

[ci-badge]:            https://github.com/romanchechyotkin/avito_test_task/actions/workflows/test.yaml/badge.svg
[ci-runs]:             https://github.com/romanchechyotkin/avito_test_task/actions
[coverage-badge]:      https://raw.githubusercontent.com/romanchechyotkin/avito_test_task/badges/.badges/master/coverage.svg


Микросервис, с помощью которого пользователь сможет продать квартиру, загрузив объявление на Авито. Перед появлением объявления на сайте, квартира должна пройти модерацию

Используемые технологии:
- PostgreSQL (база данных)
- Docker (для запуска сервиса)
- Swagger (для документации API)
- Gin (веб фреймворк)
- golang-migrate/migrate (для миграций БД)
- pgx (драйвер для работы с PostgreSQL)
- uber/mock, testify (для тестирования)

# Configuration


Сконфигурировать приложение можно используя `config.yaml`, указав путь до файла в переменной `CONFIG_PATH`
#### example
```shell
  export CONFIG_PATH=config/config.yaml
```

```yaml
http:
  host: localhost
  port: 8080
postgresql:
  user: user
  password: password
  host: localhost
  port: 5432
  database: postgres
  ssl_mode: disable
  auto_create: false
jwt:
  sign_key: secret
  token_ttl: 60m
```

вместе с файлом приложение можно настроить используя перемнные окружения
- `CONFIG_PATH=path` - настройка расположения yaml конфиг файла; дефолт значение = "config.yaml"
- `APP_ENV=prod/dev` - настройка окружения приложения
- `LOG_LEVEL=debug/info/warn/error` - настройка уровня логирования; дефолт значение = "debug"

для всех полей из yaml файла есть переменные окружения для конфигурации

- `PORT`
- `HOST`
- `PG_USER`
- `PG_PASSWORD`
- `PG_HOST`
- `PG_PORT`
- `PG_DATABASE`
- `PG_SSL`
- `PG_AUTO_CREATE`
- `JWT_KEY`
- `JWT_TTL`

# Usage

Запустить сервис можно с помощью команды 

```shell
   make compose-up
```

Документацию после завпуска сервиса можно посмотреть по адресу `http://localhost:8080/swagger/index.html`
с портом 8080 по умолчанию

Запуск юнит тестов
```shell
  make unit-test
```

Запуск интеграционных тестов
```shell
  make integration-test
```

Запуск всех тестов
```shell
  make test
```

Запуск всех тестов с покрытием для получения отчёта в html
```shell
  make coverage-html
```

# Decisions <a name="decisions"></a>

В ходе разработки был сомнения по тем или иным вопросам, которые были решены следующим образом:

todo

1. При создании счёта стоит ли указывать id/uuid аккаунта в параметрах,
   чтобы сервис мог использовать свои собственные id/uuid для идентификации и не хранить внешние id сервиса управления балансом.
> Решил, что не стоит, т.к. это увеличит время на разработку. Но возможно в будущем стоит добавить эту возможность
2. Как реализовать резервирование денег?
> Сначала была идея сделать отдельную сущность под отдельный счёт пользователя,
но потом решил, что достаточно хранить все резервирования в одной таблице и при необходимости делать по ней поиск
3. Как составлять отчёт?
> В задании указано, что нужно вернуть ссылку на отчёт. Была идея развернуть ftp сервер и хранить отчёты in-memory.
Всё-таки решил, что интеграция с Google Drive это интереснее, но в качестве альтернативы оставил возможность получить csv файл через http.
К тому же, архитектура позволяет в будущем легко переехать на внутреннее решение
4. Какой использовать тип пагинации?
> Каждый способ имеет свои преимущества и недостатки. Limit-Offset теряет в скорости работы и консистентности данных,
так как если между получениями смежных страниц, будут добавлены данные, то это приведёт к дублированию и потере записи.
От использования курсора пришлось отказаться, так как на одну дату может быть множество операций,
тогда затруднительно получить отличные от первой страницы, нужно было бы увеличивать точность даты курсора, что усложнило бы разработку